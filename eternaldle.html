<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternaldle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1d;
            color: #e2e2e2;
        }
        .correct-bg { background-color: #2a9d8f; }
        .partial-bg { background-color: #e9c46a; }
        .incorrect-bg { background-color: #e76f51; }
        .higher-bg, .lower-bg { background-color: #f4a261; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: #1a1a1d;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        .toast.success { background-color: #c7c7c7; }
        .toast.error { background-color: #e76f51; }
        .character-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #2c2c31;
        }
        #characterInput {
            background-color: #2c2c31;
            border: 1px solid #4a4a52;
        }
        #characterInput:focus {
            outline: none;
            border-color: #7a7a85;
            box-shadow: 0 0 0 2px rgba(90, 90, 100, 0.5);
        }
        .win-message {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center mb-2">Eternaldle</h1>
        <p class="text-center text-gray-400 mb-6">Adivinhe o personagem de hoje!</p>
        
        <div id="game-container" class="mb-6">
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="characterInput" list="characterList" placeholder="Digite o nome de um personagem..." class="flex-grow p-3 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <datalist id="characterList"></datalist>
                <button id="guessButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors">Adivinhar</button>
            </div>
        </div>

        <div id="win-message-container" class="text-center hidden"></div>

        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="w-full text-sm text-left">
                <thead class="bg-[#2c2c31] text-xs uppercase">
                    <tr>
                        <th scope="col" class="px-4 py-3">Personagem</th>
                        <th scope="col" class="px-4 py-3">Gênero</th>
                        <th scope="col" class="px-4 py-3">Classe</th>
                        <th scope="col" class="px-4 py-3">Alcance</th>
                        <th scope="col" class="px-4 py-3">Cabelo</th>
                        <th scope="col" class="px-4 py-3">Lançamento</th>
                        <th scope="col" class="px-4 py-3">Armas</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <!-- As linhas de resultado serão inseridas aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const characterInput = document.getElementById('characterInput');
        const guessButton = document.getElementById('guessButton');
        const resultsBody = document.getElementById('results-body');
        const characterList = document.getElementById('characterList');
        const winMessageContainer = document.getElementById('win-message-container');
        const gameContainer = document.getElementById('game-container');
        
        let characterNames = [];
        let isGameOver = false;

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.classList.add(isError ? 'error' : 'success');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        async function startGame() {
            try {
                // A chamada fetch usa um caminho relativo, que é a forma mais robusta.
                // Se isto falhar, o erro será capturado e exibido na consola.
                const response = await fetch('/api/start_game', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Resposta inválida do servidor.' }));
                    throw new Error(errorData.error || `Erro do Servidor: ${response.status}`);
                }

                const data = await response.json();
                characterNames = data.characterNames.map(name => name.trim());
                characterList.innerHTML = characterNames.map(name => `<option value="${name}"></option>`).join('');

            } catch (error) {
                console.error("ERRO DETALHADO AO INICIAR O JOGO (fetch):", error);
                showToast('Falha grave ao comunicar com o servidor. Verifique a consola (F12).', true);
            }
        }

        async function handleGuess() {
            const guess = characterInput.value.trim();
            if (isGameOver || !guess) return;
            
            if (!characterNames.some(name => name.toLowerCase() === guess.toLowerCase())) {
                showToast("Nome de personagem inválido", true);
                return;
            }

            try {
                const response = await fetch('/api/guess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ guess: guess })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Resposta inválida do servidor.' }));
                    throw new Error(errorData.error || `Erro do Servidor: ${response.status}`);
                }
                
                const data = await response.json();
                renderResults(data.results);

                if (data.isCorrect) {
                    isGameOver = true;
                    gameContainer.classList.add('hidden');
                    winMessageContainer.innerHTML = `<h2 class="text-3xl font-bold text-green-400 win-message">Parabéns! Você acertou!</h2>`;
                    winMessageContainer.classList.remove('hidden');
                    showToast('Você venceu!', false);
                }
                characterInput.value = '';
            
            } catch (error) {
                console.error("ERRO DETALHADO AO FAZER PALPITE (fetch):", error);
                showToast('Falha ao comunicar com o servidor. Verifique a consola (F12).', true);
            }
        }

        function renderResults(results) {
            const row = document.createElement('tr');
            row.classList.add('bg-[#212124]', 'border-b', 'border-gray-700');

            const statusToClass = {
                correct: 'correct-bg',
                partial: 'partial-bg',
                incorrect: 'incorrect-bg',
                higher: 'higher-bg',
                lower: 'lower-bg'
            };

            const createCell = (content, status) => {
                const cell = document.createElement('td');
                cell.className = `px-4 py-2 font-medium whitespace-nowrap text-white ${statusToClass[status] || ''}`;
                cell.innerHTML = content;
                return cell;
            };

            const characterCell = document.createElement('td');
            characterCell.className = `px-4 py-2 font-medium whitespace-nowrap text-white ${statusToClass[results.nome.status]}`;
            const img = document.createElement('img');
            img.src = results.imagem_url.value;
            img.alt = results.nome.value;
            img.className = 'character-image inline-block mr-3';
            img.crossOrigin = "anonymous"; // Importante para CORS
            img.onerror = () => { 
                console.error("Falha ao carregar imagem:", results.imagem_url.value);
                img.alt = "Falha";
            };
            characterCell.appendChild(img);
            characterCell.append(results.nome.value);
            
            row.appendChild(characterCell);
            row.appendChild(createCell(results.genero.value, results.genero.status));
            row.appendChild(createCell(results.classe.value, results.classe.status));
            row.appendChild(createCell(results.alcance.value, results.alcance.status));
            row.appendChild(createCell(results.cor_cabelo.value, results.cor_cabelo.status));
            
            let launchContent = results.ano_de_lancamento.value;
            if(results.ano_de_lancamento.status === 'higher') launchContent += ' ↓'; // Corrigido
            if(results.ano_de_lancamento.status === 'lower') launchContent += ' ↑'; // Corrigido
            row.appendChild(createCell(launchContent, results.ano_de_lancamento.status));

            let weaponContent = results.quantidade_de_arma.value;
            if(results.quantidade_de_arma.status === 'higher') weaponContent += ' ↓'; // Corrigido
            if(results.quantidade_de_arma.status === 'lower') weaponContent += ' ↑'; // Corrigido
            row.appendChild(createCell(weaponContent, results.quantidade_de_arma.status));

            resultsBody.prepend(row);
        }

        document.addEventListener('DOMContentLoaded', startGame);
        guessButton.addEventListener('click', handleGuess);
        characterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleGuess();
            }
        });
    </script>
</body>
</html>

