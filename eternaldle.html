<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternaldle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center mb-2 site-title">Eternaldle</h1>
        <p class="text-center text-gray-400 mb-6">Adivinhe o personagem de hoje!</p>
        
        <div id="game-container" class="mb-6">
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="characterInput" list="characterList" placeholder="Digite o nome de um personagem..." class="flex-grow p-3 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <datalist id="characterList"></datalist>
                <p id="input-warning" class="mt-2 text-sm text-red-400 hidden">VocÃª jÃ¡ chutou esse personagem.</p>
                <button id="guessButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors">Adivinhar</button>
            </div>
        </div>

        .numeric-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        #toast-container {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
        .toast {
            background-color: #eee;
            color: #111;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .toast.error { background-color: var(--error-bg); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Eternaldle</h1>
            <div id="winners-info">A carregar estatÃ­sticas...</div>
        </header>

        <form id="guess-form" autocomplete="off">
            <input type="text" id="character-input" list="character-list" placeholder="Escreva o nome do personagem...">
            <datalist id="character-list"></datalist>
            <button type="submit" id="guess-button">Adivinhar</button>
        </form>

        <div id="results-container">
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Imagem</th>
                        <th>Personagem</th>
                        <th>GÃªnero</th>
                        <th>Classe(s)</th>
                        <th>Alcance</th>
                        <th>Cabelo</th>
                        <th>LanÃ§amento</th>
                        <th>Armas</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const characterInput = document.getElementById('character-input');
        const characterDatalist = document.getElementById('character-list');
        const resultsTableBody = document.querySelector('#results-table tbody');
        const winnersInfo = document.getElementById('winners-info');
        
        let characterNames = [];
        let guessedNames = new Set();
        let isGameOver = false;

        // LocalStorage helpers to persist guesses per-solution (by date)
        const todayKey = () => `eternaldle_guesses_${new Date().toISOString().slice(0,10)}`;
        const wonKey = () => `eternaldle_won_${new Date().toISOString().slice(0,10)}`;

        function loadLocalGuesses() {
            try {
                const raw = localStorage.getItem(todayKey());
                return raw ? JSON.parse(raw) : [];
            } catch (e) { return []; }
        }
        function saveLocalGuesses(guesses) {
            try { localStorage.setItem(todayKey(), JSON.stringify(guesses)); } catch (e) { /* ignore */ }
        }
        function setLocalWon(flag) {
            try { localStorage.setItem(wonKey(), flag ? '1' : ''); } catch (e) {}
        }
        function getLocalWon() {
            try { return !!localStorage.getItem(wonKey()); } catch (e) { return false; }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.classList.add(isError ? 'error' : 'success');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Remove um personagem chutado da lista de sugestÃµes (e atualiza a datalist)
        function removeCharacterFromList(name) {
            try {
                const l = (name || '').trim().toLowerCase();
                if (!l) return;
                // marca como chutado para impedir reaparecer mesmo digitando manualmente
                guessedNames.add(l);
                characterNames = characterNames.filter(n => n.toLowerCase() !== l);
                const val = characterInput.value.trim();
                if (val.length >= 2 && characterNames && characterNames.length > 0) {
                    const q = val.toLowerCase();
                    const matches = characterNames.filter(n => n.toLowerCase().includes(q)).slice(0, 50);
                    characterList.innerHTML = matches.map(n => `<option value="${n}"></option>`).join('');
                } else {
                    characterList.innerHTML = '';
                }
            } catch (e) {
                console.error('Erro removendo personagem da lista', e);
            }
        }

        // --- Compartilhamento para Discord --- ðŸ”§
        function getShareText() {
            try {
                const guesses = loadLocalGuesses();
                if (!guesses || guesses.length === 0) return `Eternaldle â€” sem chutes registrados hoje.`;

                const order = ['nome','genero','classe','alcance','cor_cabelo','ano_de_lancamento','quantidade_de_arma'];
                const statusToEmoji = (status) => {
                    if (status === 'correct') return 'ðŸŸ©';
                    if (status === 'partial' || status === 'higher' || status === 'lower') return 'ðŸŸ¨';
                    return 'ðŸŸ¥';
                };

                const rows = guesses.map(g => {
                    const res = g.results || {};
                    return order.map(k => {
                        const s = res[k] && res[k].status ? res[k].status : 'incorrect';
                        return statusToEmoji(s);
                    }).join('');
                }).join('\n');

                const attempts = guesses.length;
                return `Eternaldle â€” Acertou em ${attempts} tentativa${attempts === 1 ? '' : 's'}\n\n${rows}\n\n(atributos: nome, gÃªnero, classe, alcance, cabelo, lanÃ§amento, armas)\nJogue: ${location.origin}${location.pathname}`;
            } catch (e) {
                console.error('Erro ao gerar texto para compartilhamento', e);
                return 'Eternaldle';
            }
        }

        function createShareButton() {
            const btn = document.createElement('button');
            btn.id = 'shareDiscordButton';
            btn.type = 'button';
            btn.className = 'mt-4 bg-[#5865F2] hover:bg-[#4b54d6] text-white font-bold py-2 px-4 rounded-md transition-colors';
            btn.textContent = 'Compartilhar';

            btn.addEventListener('click', async () => {
                const text = getShareText();
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    }
                    showToast('Resultado copiado! Cole no Discord ou onde quiser. âœ…');
                } catch (err) {
                    console.error('Falha ao copiar para a Ã¡rea de transferÃªncia', err);
                    showToast('NÃ£o foi possÃ­vel copiar automaticamente. Copie manualmente.', true);
                }
            });

            return btn;
        }

        function showWinMessage(countText = '') {
            winMessageContainer.innerHTML = `<h2 class="text-3xl font-bold text-green-400 win-message">ParabÃ©ns! VocÃª acertou!</h2>${countText}`;
            // remove wrap existente se houver
            const existing = document.getElementById('shareWrap');
            if (existing) existing.remove();
            // adiciona botÃ£o de compartilhar
            const shareWrap = document.createElement('div');
            shareWrap.id = 'shareWrap';
            shareWrap.className = 'flex flex-col items-center';
            shareWrap.appendChild(createShareButton());
            const small = document.createElement('p');
            small.className = 'mt-2 text-gray-300 text-sm text-center';
            small.textContent = 'Clique em "Compartilhar" para copiar o resumo (ðŸŸ©=correto, ðŸŸ¨=parcial/maior/menor, ðŸŸ¥=incorreto) â€” um quadrado por atributo: nome, gÃªnero, classe, alcance, cabelo, lanÃ§amento, armas.';
            shareWrap.appendChild(small);
            winMessageContainer.appendChild(shareWrap);
            winMessageContainer.classList.remove('hidden');
        }

        async function startGame() {
            try {
                const response = await fetch('/api/start_game', { method: 'POST', credentials: 'include' });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                const data = await response.json();
                characterNames = data.characterNames.map(name => name.trim());
                // Do not populate the datalist immediately â€” populate when user types >=2 chars
                characterList.innerHTML = '';

                // Restore persisted guesses for this session/day
                const localGuesses = loadLocalGuesses();
                if (localGuesses && localGuesses.length > 0) {
                    localGuesses.forEach(g => {
                        try { renderResults(g.results); } catch (e) { console.error('Failed to render a local previous guess', e); }
                        if (g && g.guess) removeCharacterFromList(g.guess);
                    });
                } else if (data.previousGuesses && data.previousGuesses.length > 0) {
                    // If server has session guesses but local doesn't, adopt server-side guesses into local
                    data.previousGuesses.forEach(g => {
                        try { renderResults(g.results); } catch (e) { console.error('Failed to render a previous guess', e); }
                        if (g && g.guess) removeCharacterFromList(g.guess);
                    });
                    try { saveLocalGuesses(data.previousGuesses); } catch (e) {}
                }

                // If the session already won for today, show win state
                const localWon = getLocalWon();
                if (data.hasWon || localWon) {
                    isGameOver = true;
                    gameContainer.classList.add('hidden');
                    let countText = '';
                    if (typeof data.todayCorrectCount !== 'undefined') {
                        const n = data.todayCorrectCount;
                        countText = `<p class="mt-2 text-gray-300">${n} ${n === 1 ? 'pessoa acertou' : 'pessoas acertaram'} o personagem de hoje.</p>`;
                    }
                    showWinMessage(countText);
                }

            } catch (error) {
                showToast(error.message, true);
            }
        }

        // --- NOVA LÃ“GICA DE FILTRAGEM DINÃ‚MICA ---
        characterInput.addEventListener('input', (e) => {
            const val = e.target.value.trim().toLowerCase();
            
            // Se o campo estiver vazio, limpamos a lista
            if (val.length < 1) {
                characterDatalist.innerHTML = '';
                return;
            }

            // Filtramos os nomes que contÃªm o texto digitado
            const filtered = characterNames.filter(name => 
                name.toLowerCase().includes(val)
            );

            // Atualizamos a datalist apenas com os resultados filtrados (limite de 10 para nÃ£o poluir)
            characterDatalist.innerHTML = filtered
                .slice(0, 10)
                .map(n => `<option value="${n}">`)
                .join('');
        });

        function updateWinnersUI(count) {
            winnersInfo.textContent = `${count} ${count === 1 ? 'pessoa acertou' : 'pessoas acertaram'} o personagem de hoje.`;
        }

        document.getElementById('guess-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const guess = characterInput.value.trim();
            if (isGameOver || !guess) return;

            // Impede palpites duplicados
            const existingGuesses = loadLocalGuesses();
            if (existingGuesses && existingGuesses.some(g => g.guess && g.guess.toLowerCase() === guess.toLowerCase())) {
                showToast('VocÃª jÃ¡ chutou esse personagem', true);
                return;
            }

            if (!characterNames.some(name => name.toLowerCase() === guess.toLowerCase())) {
                showToast("Nome de personagem invÃ¡lido", true);
                return;
            }

            try {
                const response = await fetch('/api/guess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guess }),
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                renderRow(data.results);

                if (data.isCorrect) {
                    isGameOver = true;
                    gameContainer.classList.add('hidden');
                    let countText = '';
                    if (typeof data.todayCorrectCount !== 'undefined') {
                        const n = data.todayCorrectCount;
                        countText = `<p class="mt-2 text-gray-300">${n} ${n === 1 ? 'pessoa acertou' : 'pessoas acertaram'} o personagem de hoje.</p>`;
                    }
                    showWinMessage(countText);
                    showToast('VocÃª venceu!', false);
                    // Mark local won flag
                    setLocalWon(true);
                }

                // Persist this guess locally so it survives F5 (avoid duplicates)
                try {
                    const lsKey = todayKey();
                    const existing = loadLocalGuesses();
                    const entry = { guess: guess, results: data.results, isCorrect: data.isCorrect };
                    if (!existing.some(g => g.guess.toLowerCase() === guess.toLowerCase())) {
                        existing.push(entry);
                        saveLocalGuesses(existing);
                    }
                    // Remove the guessed name so the user cannot chutar de novo
                    removeCharacterFromList(guess);
                } catch (e) { console.error('Could not persist guess locally', e); }

                characterInput.value = '';
                characterDatalist.innerHTML = ''; // Limpa a lista apÃ³s o envio
            } catch (error) {
                showToast(error.message, true);
            }
        });

        function renderRow(res) {
            const row = document.createElement('tr');
            row.className = 'result-row';
            
            const cols = ['imagem_url', 'nome', 'genero', 'classe', 'alcance', 'cor_cabelo', 'ano_de_lancamento', 'quantidade_de_arma'];
            
            cols.forEach(key => {
                const cell = document.createElement('td');
                const item = res[key];
                
                if (key === 'imagem_url') {
                    const img = document.createElement('img');
                    img.src = item.value;
                    img.className = 'character-image';
                    img.alt = "[Imagem do Personagem]";
                    cell.appendChild(img);
                    cell.className = res.nome.status;
                } else if (key === 'ano_de_lancamento' || key === 'quantidade_de_arma') {
                    cell.className = item.status;
                    const arrow = item.status === 'higher' ? 'â¬†' : (item.status === 'lower' ? 'â¬‡' : '');
                    cell.innerHTML = `<div class="numeric-cell">${item.value} ${arrow}</div>`;
                } else {
                    cell.className = item.status;
                    cell.textContent = String(item.value).replace(/,/g, ', ');
                }
                row.appendChild(cell);
            });
            resultsTableBody.prepend(row);
        }

        function showToast(msg, isError = false) {
            const t = document.createElement('div');
            t.className = `toast ${isError ? 'error' : ''}`;
            t.textContent = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                setTimeout(() => t.remove(), 500);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', startGame);
        // Update datalist only after user types 2+ characters and prevent guessing already-chutados
        characterInput.addEventListener('input', () => {
            const val = characterInput.value.trim();
            const valLower = val.toLowerCase();
            const warning = document.getElementById('input-warning');

            if (val && guessedNames.has(valLower)) {
                // bloqueia envio e mostra aviso
                guessButton.disabled = true;
                guessButton.classList.add('opacity-50', 'cursor-not-allowed');
                warning.classList.remove('hidden');
                warning.textContent = 'VocÃª jÃ¡ chutou esse personagem.';
                characterList.innerHTML = '';
                return;
            } else {
                guessButton.disabled = false;
                guessButton.classList.remove('opacity-50', 'cursor-not-allowed');
                warning.classList.add('hidden');
            }

            if (val.length >= 2 && characterNames && characterNames.length > 0) {
                const q = val.toLowerCase();
                // Use case-insensitive partial match and limit number of options
                const matches = characterNames.filter(name => name.toLowerCase().includes(q)).slice(0, 50);
                characterList.innerHTML = matches.map(name => `<option value="${name}"></option>`).join('');
            } else {
                characterList.innerHTML = '';
            }
        });
        guessButton.addEventListener('click', handleGuess);
        characterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (guessButton.disabled) {
                    e.preventDefault();
                    showToast('VocÃª jÃ¡ chutou esse personagem', true);
                    return;
                }
                handleGuess();
            }
        });
    </script>
</body>
</html>




